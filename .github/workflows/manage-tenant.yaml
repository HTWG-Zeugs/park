name: Manage tenant

on:
  # Reusable workflows must define `workflow_call` instead of `workflow_dispatch`.
  workflow_call:
    # 1) Generic environment inputs
    inputs:
      environment:
        type: string
        description: "Which environment (e.g. 'staging' or 'production')?"
        required: true
      project_id:
        type: string
        required: true
      project_number:
        type: string
        required: true
      region:
        type: string
        required: true
      domain:
        type: string
        required: true
      state_bucket:
        type: string
        required: true

      # 2) Tenant inputs (originally from `workflow_dispatch`)
      tenant_action:
        type: string
        required: true
        description: "add or remove"
      tenant_id:
        type: string
        required: true
      tenant_subdomain:
        type: string
        required: true

    # 3) Secrets
    secrets:
      workload_identity_provider:
        required: true
      identity_platform_api_key:
        required: true

permissions:
  id-token: write
  contents: read

env:
  TAG_ID: ${{ github.sha }}

jobs:
  manage-tenant:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Login to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          service_account: "github-sa@${{ inputs.project_id }}.iam.gserviceaccount.com"
          workload_identity_provider: ${{ secrets.workload_identity_provider }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"
      - run: pip install -r ci-cd/requirements.txt

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - uses: hashicorp/setup-terraform@v3

      - name: Manage enterprise tenants
        working-directory: ./ci-cd
        run: |
          python -u manage_enterprise_tenants.py \
            --action ${{ inputs.tenant_action }} \
            --gcs-bucket ${{ inputs.state_bucket }} \
            --tenant-id ${{ inputs.tenant_id }} \
            --tenant-subdomain ${{ inputs.tenant_subdomain }}

  sync-terraform:
    runs-on: ubuntu-latest
    needs: manage-tenant
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Login to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          service_account: "github-sa@${{ inputs.project_id }}.iam.gserviceaccount.com"
          workload_identity_provider: ${{ secrets.workload_identity_provider }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"
      - run: pip install -r ci-cd/requirements.txt

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - uses: hashicorp/setup-terraform@v3

      - name: Run terraform apply
        working-directory: ./ci-cd
        run: |
          python -u deploy-terraform.py \
            --action apply \
            --is-github-actions \
            --create-cluster \
            --project-id ${{ inputs.project_id }} \
            --gcs-bucket ${{ inputs.state_bucket }} \
            --domain-name ${{ inputs.domain }} \
            --region ${{ inputs.region }} \
            --environment ${{ inputs.environment }}

  sync-services:
    runs-on: ubuntu-latest
    needs: sync-terraform
    env:
      SERVICE_AUDIENCE: "infrastructure-administration-service"

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Login to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          service_account: "github-sa@${{ inputs.project_id }}.iam.gserviceaccount.com"
          workload_identity_provider: ${{ secrets.workload_identity_provider }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ inputs.project_id }}-gke
          location: ${{ inputs.region }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"
      - run: pip install -r ci-cd/requirements.txt

      - name: Sync helm deployments
        working-directory: ./ci-cd
        run: |
          python -u deploy-kubernetes.py \
            --is-github-actions \
            --project-id ${{ inputs.project_id }} \
            --gcs-bucket ${{ inputs.state_bucket }} \
            --repository "${{ inputs.region }}-docker.pkg.dev/${{ inputs.project_id }}/docker-repository" \
            --identity-api-key ${{ secrets.identity_platform_api_key }} \
            --identity-auth-domain ${{ inputs.project_id }}.firebaseapp.com \
            --infra-url https://infrastructure-administration-${{ inputs.project_number }}.${{ inputs.region }}.run.app \
            --auth-url https://authentication-service-${{ inputs.project_number }}.${{ inputs.region }}.run.app \
            --domain ${{ inputs.domain }} \
            --region ${{ inputs.region }}
